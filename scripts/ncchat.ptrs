import strcpy, isprint, isspace, printf;
import SocketServer, SocketSet from "../libs/socket.ptrs";

const port = 3112;
var server = new SocketServer(port);
var sockset = new SocketSet();
var broadcast;

sockset.add(server);

struct Client
{
	nick{16};
	antiSpam = 0;

	destructor()
	{
		broadcast(nick, '-', "left");
	}
};

function broadcast(nick, splitter, buff)
{
	var msg = "%-10.10s %c %s\n" % nick, splitter, buff;
	printf("%s", msg);

	foreach(sock in sockset)
	{
		try
		{
			if(sock != server && sock.userdata.nick[0] != 0)
				sock.sends(msg);
		}
		catch(e)
		{
			printf("/!\\ %-6.6s ! %s\n", sock.userdata.nick, e);
		}
	}
}

while(true)
{
	var sock = sockset.check();
	var client = sock.userdata;

	try
	{
		if(sock == server)
		{
			sock = server.accept();

			var client = new Client();
			client.nick[0] = 0;
			sock.userdata = client;
			sockset.add(sock);

			sock.sends("Welcome to this simple chat written in PointerScript\n");
			sock.sends("You can read the source at http://bit.ly/1XaCDlz\nCurrently online: ");
			foreach(c in sockset)
			{
				if(c != server && c.userdata.nick[0] != 0)
				{
					sock.sends(c.userdata.nick);
					sock.sends(", ");
				}
			}
			sock.sends("\nType your nickname: ");
		}
		else
		{
			var buff{256};
			var splitter = ':';

			var len = 0;
			var spaceOnly = true;
			function filter(c)
			{
				if(!isspace(c))
					spaceOnly = false;
				if(c == '\n')
					return undefined;

				len++;
				return true;
			}

			sock => filter => isprint => buff;
			buff[len] = 0;

			if(sock.closed)
			{
				sockset.remove(sock);
				delete sock.userdata;
				delete sock;
				continue;
			}

			//client.antiSpam += 10;
			//if(spaceOnly || client.antiSpam > 19)
			//	continue;

			if(client.nick[0] == 0)
			{
				buff[15] = 0;
				strcpy(client.nick, buff, 16);
				strcpy(buff, "joined");
				splitter = '-';
			}
			broadcast(client.nick, splitter, buff);
		}
	}
	catch(e, trace)
	{
		printf("/!\\ %-6.6s ! %s\n%s", client ? client.nick : "?", e, trace);

		sockset.remove(sock);
		delete client;
		delete sock;
	}
}
